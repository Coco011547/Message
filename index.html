
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Send Output to WhatsApp (Twilio + Vercel)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; line-height: 1.4; }
    .card { max-width: 860px; margin: 0 auto; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; }
    h1 { margin: 0 0 10px; font-size: 20px; }
    label { display:block; margin: 12px 0 6px; font-weight: 600; }
    input, textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 14px; }
    textarea { min-height: 110px; resize: vertical; }
    .row { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 700px){ .row{ grid-template-columns: 1fr; } }
    .btns { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; font-weight: 700; }
    .primary { background: #16a34a; color: white; }
    .secondary { background: #111827; color: white; }
    .muted { background: #f3f4f6; color: #111827; }
    .hint { font-size: 13px; color: #6b7280; margin-top: 6px; }
    .outputBox { border: 1px dashed #9ca3af; border-radius: 10px; padding: 12px; background: #fafafa; }
    .status { margin-top: 12px; padding: 10px; border-radius: 10px; display:none; }
    .ok { background: #ecfdf5; border: 1px solid #10b981; color: #065f46; }
    .err { background: #fef2f2; border: 1px solid #ef4444; color: #7f1d1d; }
    code { background: #f3f4f6; padding: 1px 6px; border-radius: 6px; }
  </style>
</head>

<body>
  <div class="card">
    <h1>Send Output from index.html to WhatsApp</h1>

    <p class="hint">
      This page sends your <strong>output text</strong> to a backend endpoint
      <code>/api/send-whatsapp</code> (Vercel function). Your Twilio credentials must stay on the server.
    </p>

    <!-- Example Inputs (optional) -->
    <div class="row">
      <div>
        <label for="name">Example Input: Name</label>
        <input id="name" type="text" placeholder="Enter name (optional)" />
      </div>
      <div>
        <label for="value">Example Input: Value</label>
        <input id="value" type="number" placeholder="Enter a number (optional)" />
      </div>
    </div>

    <div class="btns">
      <button class="secondary" id="calcBtn" type="button">Generate Output</button>
      <button class="muted" id="copyBtn" type="button">Copy Output</button>
    </div>

    <label>Generated Output (this will be sent)</label>
    <div id="output" class="outputBox">
      Click <strong>Generate Output</strong> to create a message.
    </div>

    <div class="row" style="margin-top: 14px;">
      <div>
        <label for="toNumber">To (optional)</label>
        <input
          id="toNumber"
          type="text"
          placeholder="whatsapp:+91xxxxxxxxxx  (leave blank to use WHATSAPP_TO_DEFAULT)"
        />
        <div class="hint">
          Format must be <code>whatsapp:+E164</code> (example: <code>whatsapp:+9199xxxxxxx</code>). 
        </div>
      </div>
      <div>
        <label for="prefix">Message Prefix (optional)</label>
        <input id="prefix" type="text" value="Output from index.html:" />
      </div>
    </div>

    <label for="extraNote">Extra Note (optional)</label>
    <textarea id="extraNote" placeholder="Add any extra line(s) before sending..."></textarea>

    <div class="btns">
      <button class="primary" id="sendBtn" type="button">Send to WhatsApp</button>
      <button class="muted" id="clearBtn" type="button">Clear</button>
    </div>

    <div id="statusOk" class="status ok"></div>
    <div id="statusErr" class="status err"></div>

    <p class="hint">
      If you are using Twilio <strong>Sandbox</strong>, your WhatsApp must join the sandbox and messages come from
      <code>whatsapp:+14155238886</code>. 
    </p>
  </div>

  <script>
    // ---------- Helpers ----------
    function showOk(msg) {
      const ok = document.getElementById("statusOk");
      const err = document.getElementById("statusErr");
      err.style.display = "none";
      ok.textContent = msg;
      ok.style.display = "block";
    }

    function showErr(msg) {
      const ok = document.getElementById("statusOk");
      const err = document.getElementById("statusErr");
      ok.style.display = "none";
      err.textContent = msg;
      err.style.display = "block";
    }

    function getOutputText() {
      return (document.getElementById("output").innerText || "").trim();
    }

    function setOutputText(text) {
      document.getElementById("output").innerText = text;
    }

    function sanitizeToWhatsAppAddress(value) {
      // Allow empty (means backend uses WHATSAPP_TO_DEFAULT)
      if (!value) return "";

      const v = value.trim();

      // Basic validation: should start with "whatsapp:+"
      if (!v.startsWith("whatsapp:+")) {
        throw new Error("Invalid To number. Use format: whatsapp:+<countrycode><number>");
      }

      // Very light check for digits after whatsapp:+
      const digits = v.replace("whatsapp:+", "");
      if (!/^\d{8,15}$/.test(digits)) {
        throw new Error("Invalid To number digits. Example: whatsapp:+919876543210");
      }

      return v;
    }

    // ---------- Demo: Generate Output ----------
    document.getElementById("calcBtn").addEventListener("click", () => {
      const name = (document.getElementById("name").value || "").trim();
      const val = (document.getElementById("value").value || "").trim();

      // Customize this section to build your real output
      const now = new Date().toLocaleString();
      const lines = [
        `Generated at: ${now}`,
        name ? `Name: ${name}` : null,
        val ? `Value: ${val}` : null,
        `Status: OK`
      ].filter(Boolean);

      setOutputText(lines.join("\n"));
      showOk("Output generated successfully.");
    });

    // ---------- Copy Output ----------
    document.getElementById("copyBtn").addEventListener("click", async () => {
      try {
        const text = getOutputText();
        await navigator.clipboard.writeText(text);
        showOk("Output copied to clipboard.");
      } catch (e) {
        showErr("Copy failed. Your browser may block clipboard access.");
      }
    });

    // ---------- Clear ----------
    document.getElementById("clearBtn").addEventListener("click", () => {
      document.getElementById("name").value = "";
      document.getElementById("value").value = "";
      document.getElementById("toNumber").value = "";
      document.getElementById("extraNote").value = "";
      setOutputText("Click Generate Output to create a message.");
      document.getElementById("statusOk").style.display = "none";
      document.getElementById("statusErr").style.display = "none";
    });

    // ---------- Send to WhatsApp ----------
    document.getElementById("sendBtn").addEventListener("click", async () => {
      try {
        const output = getOutputText();
        if (!output || output === "Click Generate Output to create a message.") {
          showErr("No real output found. Click 'Generate Output' first.");
          return;
        }

        const prefix = (document.getElementById("prefix").value || "").trim();
        const extra = (document.getElementById("extraNote").value || "").trim();

        // Build final message
        let message = "";
        if (prefix) message += prefix + "\n";
        if (extra) message += extra + "\n\n";
        message += output;

        // Optional: keep message size reasonable for reliability
        const MAX_LEN = 1500;
        if (message.length > MAX_LEN) {
          message = message.slice(0, MAX_LEN) + "\n…(trimmed)";
        }

        // Optional "to"
        const toRaw = document.getElementById("toNumber").value;
        const to = sanitizeToWhatsAppAddress(toRaw);

        showOk("Sending…");

        const resp = await fetch("/api/send-whatsapp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, ...(to ? { to } : {}) })
        });

        const data = await resp.json().catch(() => ({}));

        if (!resp.ok) {
          throw new Error(data.error || `HTTP ${resp.status} error while sending.`);
        }

        showOk(`✅ Sent to WhatsApp successfully! SID: ${data.sid || "(no sid returned)"}`);
      } catch (err) {
        showErr("❌ " + err.message);
      }
    });
  </script>
</body>
</html>
